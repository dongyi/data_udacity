---
title: "Red Wine Quality "
author: "Dong Yi"
date: "2017-07-08"
output:
  html_document:
    keep_md: no
    toc: yes
---

```{r packages}

library(ggplot2)
library(grid)
library(gridExtra)
library(psych)
library(dplyr)
library(knitr)
library(memisc)

# 全局配置
set.seed(1984) 

opts_chunk$set(fig.width=6, fig.height=6, fig.align='center', 
               warning=FALSE, message=FALSE, echo=FALSE,
               cache=TRUE, echo=FALSE)
```

# 数据集说明

这个整⻬的数据集包含1,599 种红酒，以及 11 个关于酒的化学成分的变量。
⾄少 3 名葡萄酒专家对每种酒的质量进⾏了评分，分数在 0（⾮常差）和 10（⾮常好）之间。



```{r load data}
# 载入数据文件

data = read.table(file = 'wineQualityReds.csv', header=TRUE, sep=',')
str(data)
names(data)[1] <- 'id'
```

总体情况:

```{r summary}
summary(data)
```

该数据集有1599个条目, 每个条目包含13个变量, 给每个条目加了一个id字段.
所有字段都是数字类型的



我们先总览一下各个属性之间的pearson相关度

```{r fig.width=10, fig.height=10, pearson}
pairs.panels(data, pch=".")
```

其中相关度较高的有:
volatile.acidity - critic.acid       -0.55
fixed.acidity - critic.acid           0.67
fixed.acidity - density               0.67
fixed.acidity - pH                   -0.68



首先观察一下quality值的分布


```{r single variable}

# 定义一个函数来画单个字段的直方图
get_basic_histogram <-  function(column, data, binwidth = diff(range(data[column]))/30)
  {
    return(ggplot(
            aes_string(x = column), data = data) + 
            geom_histogram(binwidth = binwidth)
           )
  }

get_basic_histogram("quality", data)

# quality只有6个取值: 3,4,5,6,7,8
# 我们可以把他转变成factor类型
data$quality <- factor(data$quality)

```



查看其它变量的分布
```{r single vars}
get_basic_histogram("fixed.acidity", data)
get_basic_histogram("volatile.acidity", data, 0.1)
get_basic_histogram("citric.acid", data)
get_basic_histogram("residual.sugar", data)
get_basic_histogram("chlorides", data)
get_basic_histogram("free.sulfur.dioxide", data)
get_basic_histogram("total.sulfur.dioxide", data)
get_basic_histogram("density", data)
get_basic_histogram("pH", data)
get_basic_histogram("sulphates", data)
get_basic_histogram("alcohol", data)

```

多数直方图都是右偏态分布

volatile acidity多数集中在0.2到0.7之间, 使用cut来查看一下可以发现集中在其中4个区间里

```{r single vars, fig.width=8}
qplot(cut(data$volatile.acidity,
      breaks = seq(0.0, 1.6, 0.1)))
```


再来查看一下citric acid值, 似乎有较为明显的outlier, 我们使用箱型图来查看一下

```{r single vars}
ggplot(aes(x = 'citric acid', y = citric.acid), data = data) + geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 1, 0.2))
```

可以发现1.0是个outlier, 其他值分布在0.1 到0.8 之间

free sulfur dioxide 是个明显的右偏分布, 我们使用对数坐标和根号坐标观察


```{r single vars}
get_basic_histogram("free.sulfur.dioxide", data, 0.2) +
  scale_x_log10(breaks = seq(1, 75, 5))

get_basic_histogram("free.sulfur.dioxide", data, 0.2) +
  scale_x_sqrt(breaks = seq(1, 75, 5))
```

可以看出在对数坐标下呈现正态分布, 并且有6, 11, 15, 18 这几个常见的值

  
我们现在查看一下free sulfur dioxide在total sulfur dioxide的占比情况, 定义一个新的变量

```{r single vars}
data$percent.free.sulfur.dioxide = data$free.sulfur.dioxide / data$total.sulfur.dioxide

ggplot(aes(x = percent.free.sulfur.dioxide), data = data) +
       geom_histogram(binwidth = 0.1)
```

可以看出free sulfur dioxide的百分比呈现正态分布, 均值在0.4


再观察一下alcohol值

```{r single var}
qplot(cut(data$alcohol, breaks = seq(7.0, 15.0, 0.5)))
```

可以发现多数值分布在9.0以上部分均匀递减


再观察一下residual.sugar值的分布

```{r single vars}
#qplot(cut(data$residual.sugar, breaks = seq(7.0, 15.0, 0.5)))
qplot(cut(data$residual.sugar, breaks = seq(0.5, 15.0, 1)))

ggplot(aes(x = 'residual.sugar', y = residual.sugar), data = data)
   + geom_boxplot()
   + scale_y_continuous(breaks = seq(0.5, 15.0, 2))
```
可以看出多数的residual.sugar集中在2.5左右, 较高的值呈现长尾分布


再来观察一下density值

```{r single vars}
qplot(cut(data$density, breaks = seq(0.98, 1.008, 0.002)))


```

可以看出基本呈现正态分布, 从0.99到1.004之间, 均值和中位数大约是0.997左右




现在再将quality值和其他变量结合起来综合研究. 我们将quality的值分为三组:
差: quality <= 4
中: quality in (5, 6)
优: quality >= 7

我们将这个新等级变量加入数据集的字段

```{r fig.width=10, fig.height=10, Univariate_Plots10}

classify <- function(q) {
  q <- factor(q)
  class <- ifelse(as.numeric(levels(q))[q] >= 7, "good",
                     ifelse(as.numeric(levels(q))[q] >= 5, "regular", "bad"))
  class <- factor(class)

  class <- factor(class, levels(class)[c(1, 3, 2)])
  return(class)
}

data$class <- classify(data$quality)

```

```{r fig.width=10, fig.height=10}
# 我们再画出每个属性在不同class下的密度图

var_density_plot <- function(column) {
  return(
    ggplot(aes_string(x = column), data = data) +
      geom_density(alpha = 0.3, aes(fill = class))
  )
}

p1 <- var_density_plot('fixed.acidity')
p2 <- var_density_plot('volatile.acidity')
p3 <- var_density_plot('citric.acid')
p4 <- var_density_plot('residual.sugar')
p5 <- var_density_plot('chlorides')
p6 <- var_density_plot('free.sulfur.dioxide')
p7 <- var_density_plot('percent.free.sulfur.dioxide')
p8 <- var_density_plot('total.sulfur.dioxide')
p9 <- var_density_plot('density')
p10 <- var_density_plot('pH')
p11 <- var_density_plot('sulphates')
p12 <- var_density_plot('alcohol')

grid.arrange(p1, p2, p3, p4,  p5,  p6,
             p7, p8, p9, p10, p11, p12,
             ncol = 2)
```

不同的属性下quanlity的差别提现的较为明显的有
alcohol, critic acid, volatile acidity
alcohol和critic acid和 class正相关,
而volatile acidity和 class负相关



根据之前两两变量之间perason相关系数的观察, 我们针对四个明显的变量用箱型图观察:
volatile.acidity, citric.acid, sulphates, alcohol

```{r fig.width=5, fig.height=8}
ggplot(aes(x = class, y = volatile.acidity), data = data) +
  geom_boxplot()

ggplot(aes(x = class, y = citric.acid), data = data) +
  geom_boxplot()

# 去掉outlier
ggplot(aes(x = class, y = sulphates), 
       data = subset(data, sulphates < quantile(data$sulphates, 0.9))) +
  geom_boxplot()

ggplot(aes(x = class, y = round(alcohol)), data = data) +
  geom_boxplot()

```


我们用2d密度图来观察一下几对变量之间的关系, 为了直观我们去掉了class=regular的数据, 只保留了good和bad的数据
我们来观察

```{r fig.width=8, fig.height=10}

compare_set <- subset(data, class %in% c('good', 'bad'))

# 四个变量画散点图, 2d密度图
p1 <- ggplot(aes(x = volatile.acidity, y = citric.acid),
       data = compare_set) +
  geom_point(aes(color = class)) +
  stat_density2d(aes(color = class)) 

p3 <- ggplot(aes(x = volatile.acidity, y = sulphates),
       data = compare_set) +
  geom_point(aes(color = class)) +
  stat_density2d(aes(color = class)) 

p5 <- ggplot(aes(x = volatile.acidity, y = round(alcohol)),
       data = compare_set) +
  geom_jitter(aes(color = class), 
              position = position_jitter(h = 0.3, w = 0)) +
  stat_density2d(aes(color = class))

p2 <- ggplot(aes(x = citric.acid, y = sulphates),
       data = compare_set) +
  geom_point(aes(color = class)) +
  stat_density2d(aes(color = class)) 

p4 <- ggplot(aes(x = citric.acid, y = round(alcohol)),
       data = compare_set) +
  geom_jitter(aes(color = class), 
              position = position_jitter(h = 0.3, w = 0)) +
  stat_density2d(aes(color = class))

p6 <- ggplot(aes(x = sulphates, y = round(alcohol)),
       data = compare_set) +
  geom_jitter(aes(color = class), 
              position = position_jitter(h = 0.3, w = 0)) +
  stat_density2d(aes(color = class))

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2, 
             top = paste('变量相对比较',
                         '根据品质区分'))
```


可以观察到有一些变量存在outlier, 总体上good和bad的class在这几对变量对比上差别较为明显


# 变量分析

因为"quality"的取值较为主观, 我们引入了"class"作为评估葡萄酒好坏的标准, 只有good(>7), regular(5, 6), bad(<5)三种取值, 便于观察

接下来我们比较了几对变量之间的关联性, 在不同的class下的分布情况, 我们发现regular的葡萄酒分布的比较分散, 多数情况下regular和good/bad之间的界限难以区分, 所以我们只拿good和bad两类来观察, 让结果更为明显

我们发现, 多数good级别的葡萄酒有中等的citric acid和低的volatile acidity. bad级别的葡萄酒通常有较高的volatile acidity和较低的citric acid. 同样的,good级别的葡萄酒有更高的sulphates, 更高的alcohol


### 有趣的发现?

根据之前的变量之间的关系研究, 发现citric.acid 和quality之间有正相关性.
但是如果我们观察散点图, citric.acid在good和bad级别下并没有明显的界限.


------

# 最终图形和说明

### 图1 
```{r fig.width=10, fig.height=10, p1}


# 给每个变量画密度图
draw_density_plot <- function(column) {
  return(
    ggplot(aes_string(x = column), data = data) +
      geom_density(alpha = 3/4, aes(fill = class)) +
      xlab(column) +
      theme_classic() + 
      theme(axis.text.y = element_blank(), 
            axis.title.y=element_blank(), axis.ticks.y = element_blank())
  )
}

p1 <- draw_density_plot('fixed.acidity')
p2 <- draw_density_plot('volatile.acidity')
p3 <- draw_density_plot('citric.acid')
p4 <- draw_density_plot('residual.sugar')
p5 <- draw_density_plot('chlorides')
p6 <- draw_density_plot('free.sulfur.dioxide')
p7 <- draw_density_plot('percent.free.sulfur.dioxide')
p8 <- draw_density_plot('nonfree.sulfur.dioxide')
p9 <- draw_density_plot('total.sulfur.dioxide')
p10 <- draw_density_plot('density')
p11 <- draw_density_plot('pH')
p12 <- draw_density_plot('sulphates')
p13 <- draw_density_plot('alcohol')

# 所有图整合到一起

grid.arrange(p1, p2, p3,
             p4, p5, p6,
             p7, p9, p10,
             p11, p12, p13,
             ncol = 3)

```

### 图1分析

这张图展示了数据集的每个特征的密度图, 把等级分为了三类: bad, regular, good. 使我们在不同的等级之间较为清晰的观察
观察到几个最佳的属性:volatile acidity/citric acid/sulphates/alcohol
其他属性, 比如fixed acidity, free sulfur dioxide 也有明显的分辨等级的特征


### 图2
```{r fig.width=10, fig.height=10, p2}

p1 <- ggplot(aes(x = class, y = volatile.acidity), data = data) +
  geom_boxplot(aes(fill = class)) + theme_classic() + 
  theme(legend.position="none", axis.title.x=element_blank(), 
        axis.ticks.x = element_blank()) +
  stat_summary(fun.y = mean, geom = 'point', shape = 1, size = 3)

p2 <- ggplot(aes(x = class, y = citric.acid), data = data) +
  geom_boxplot(aes(fill = class)) + theme_classic() + 
  theme(legend.position="none", axis.title.x=element_blank(), 
        axis.ticks.x = element_blank()) +
  stat_summary(fun.y = mean, geom = 'point', shape = 1, size = 3)

p3 <- ggplot(aes(x = class, y = sulphates), 
             data = subset(data, sulphates < 1.5)) +
  geom_boxplot(aes(fill = class)) + theme_classic() + 
  theme(legend.position="none", axis.title.x=element_blank(), 
        axis.ticks.x = element_blank()) +
  stat_summary(fun.y = mean, geom = 'point', shape = 1, size = 3)

p4 <- ggplot(aes(x = class, y = alcohol), data = subset(data, alcohol < 14)) +
  geom_boxplot(aes(fill = class)) + theme_classic() + 
  theme(legend.position="none", axis.title.x=element_blank(), 
        axis.ticks.x = element_blank()) +
  stat_summary(fun.y = mean, geom = 'point', shape = 1, size = 3)

grid.arrange(p1, p2, p3, p4, 
             top = "4变量箱型图")

```

### 图2 说明

我们分析了pearson相关度比较显著的4个变量:
volatile acidity, citric acid, sulphates, alcohol
使用箱型图观察, 去掉了一些outlier, 根据三种品质: bad, regular, good 使用了不同的颜色, 标注了变量的均值.
观察结果比较明显的呈现出volatile acidity和品质负相关, 其他三个变量都是正相关




### 图3
```{r fig.width=8, fig.height=10, p3}

# 保留good和bad, 并且去掉一些outlier
cleansubset <- subset(data, class %in% c('good', 'bad') & 
                        volatile.acidity < 1.5 &
                        citric.acid < 1 &
                        sulphates < 2)

# 4个主要变量两两之间的关系画散点图, 加上2d密度图
p1 <- ggplot(aes(x = volatile.acidity, y = citric.acid),
       data = cleansubset) +
  geom_point(aes(color = class)) +
  stat_density2d(aes(color = class), geom = "raster", contour = FALSE) +
  theme(legend.position="bottom")

p3 <- ggplot(aes(x = volatile.acidity, y = sulphates),
       data = cleansubset) +
  geom_point(aes(color = class))  +
  stat_density2d(aes(color = class), geom = "raster", contour = FALSE) +
  theme(legend.position="bottom")

p5 <- ggplot(aes(x = volatile.acidity, y = round(alcohol)),
       data = cleansubset) +
  stat_density2d(aes(color = class), geom = "raster", contour = FALSE) +
  theme(legend.position="bottom")

p2 <- ggplot(aes(x = citric.acid, y = sulphates),
       data = cleansubset) +
  geom_point(aes(color = class)) +
  stat_density2d(aes(color = class), geom = "raster", contour = FALSE) +
  theme(legend.position="bottom")

p4 <- ggplot(aes(x = citric.acid, y = round(alcohol)),
       data = cleansubset) +
  stat_density2d(aes(color = class), geom = "raster", contour = FALSE) +
  theme(legend.position="bottom")

p6 <- ggplot(aes(x = sulphates, y = round(alcohol)),
       data = cleansubset) +
  stat_density2d(aes(color = class), geom = "raster", contour = FALSE) +
  theme(legend.position="bottom")

grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2, 
             top = paste('4变量之间的关系密度图',
                         '根据品质区分'))
```

### 图3说明
在这张图里我们用散点图的方法用6对变量两两比较, 并且去掉了regular级别的数据, 让观察结果更加明显.
并且去掉了一些outlier. 这样更好的区分了bad和good级别的红酒在不同属性之间的差别.


------



我们分析了红酒数据集, 有1599个记录, 12个属性. 我们分析了各种属性对红酒品质的影响
确定了4个变量: 
volatile acidity, citric acid, sulphates, alcohol
讲品质分为三类:
bad, regular, good
我们发现volatile acidity和品质具有正相关, 其他三个变量和品质负相关

我们又用了多变量分析观察到不同的变量关系对红酒品质的影响
为了方便观察我们只考虑了bad和good, 因为多数情况下regular品质的红酒对我们的趋势研究没什么贡献
通过研究, good品质的红酒具有较低的volatile acidity, 较高的alcohol, bad品质的红酒

在未来的研究中, 我们可以用机器学习方法研究这个问题, 由于这个案例的数据集较小, 可以通过朴素贝叶斯方法对数据集分类.
随着数据集增大, 通过决策树/随即森林的方法能更好的对数据分类. 如果有更好的计算条件, 还可以使用支持向量机.




